#!/bin/bash
###################################
#
#  Let's Encrypt HAProxy script
#
###################################

# set PATH for all session
export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# TODO: 直接讀取 CERT_LIST_FILE 了吧
CERT_LIST_FILE="/etc/haproxy/cert-list.cfg"

# Populate DOMAINS from cert-list.cfg (skip comments and empty lines).
DOMAINS=()
if [ -f "$CERT_LIST_FILE" ]; then
  while read -r line; do
    [[ "$line" =~ ^#.*$ || -z "$line" ]] && continue
    DOMAINS+=("$(basename "$line" .pem)")
  done < "$CERT_LIST_FILE"
else
  # Fallback placeholder if cert-list not present
  DOMAINS=(all_domains)
fi

EMAIL="forwork.jan@gmail.com"
WEB_ROOT="/usr/share/nginx/html/"

#When cert is down to this many days
#It is allowed to renew
EXP_LIMIT=30;

#Only reload HAProxy if a cert was created/updated
RELOAD=false

#####################################
#
# Comment bind * 443 and reload config
#
#####################################
# read cert-list.cfg
missing_files=()
while read -r line; do
  # ignore comment lines and empty lines
  [[ "$line" =~ ^#.*$ || -z "$line" ]] && continue

  # check file exists
  if [[ ! -f "$line" ]]; then
    missing_files+=("$line")
  fi
done < /etc/haproxy/cert-list.cfg

if [[ ${#missing_files[@]} -gt 0 ]]; then
  echo "Missing some certs, we need to comment certs binding."
  sed -i 's|^ *bind   \*:443 ssl crt-list /etc/haproxy/cert-list.cfg|#&|' /usr/local/etc/haproxy/haproxy.cfg
  # haproxy -f /usr/local/etc/haproxy/haproxy.cfg
  supervisorctl restart haproxy
fi

#####################################
#
# Confirm bc command is installed
#
#####################################
command -v bc >> /dev/null
if [[ $? -ne 0 ]];
then
   echo ""
   echo "========================================================"
   echo ""
   echo "Error: cmd bc is not installed "
   echo "    To install run"
   echo "    sudo yum install bc"
   echo "========================================================"
   echo ""
   exit 1
fi

# print update time
echo "User: $(id -u -n) Update Time: $(date -d "now" +"%Y-%m-%d %H:%M:%S")"

# define combine certs function
function combine_certs() {
  local domain=$1
  mkdir -p /etc/haproxy/certs/  #location to place combine cert
  if [ -f "/etc/letsencrypt/live/$domain/fullchain.pem" ] && [ -s "/etc/letsencrypt/live/$domain/fullchain.pem" ] \
      && [ -f "/etc/letsencrypt/live/$domain/privkey.pem" ] && [ -s "/etc/letsencrypt/live/$domain/privkey.pem" ]; then
      COMBINED_FILE="/etc/haproxy/certs/${domain}.pem"
      echo "Creating $COMBINED_FILE with latest certs..."
      cat /etc/letsencrypt/live/$domain/fullchain.pem \
          /etc/letsencrypt/live/$domain/privkey.pem > $COMBINED_FILE
      # update RELOAD status
      RELOAD=true
  else
      echo "Error: Certificate files for $domain are missing or empty. Skipping..."
  fi
}

for domain in "${DOMAINS[@]}"
do
  CERT_FILE="/etc/letsencrypt/live/$domain/fullchain.pem"
  KEY_FILE="/etc/letsencrypt/live/$domain/privkey.pem"

  ##################################
  #
  # If no ssl for domain create it
  #
  ##################################
  if [ ! -f $CERT_FILE ]; then
    echo "Creating certificate for domain $domain."
    echo "If you need to check logs, please refer to /var/log/letsencrypt/letsencrypt.log"
    certbot certonly \
        --preferred-chain "ISRG Root X1" \
        --webroot --webroot-path $WEB_ROOT \
        --email $EMAIL \
        --no-eff-email \
        --agree-tos \
        -d $domain

    ###################################
    # Combine certs for HAProxy and Reload
    ###################################
    combine_certs $domain

  else
    ##################################
    # Check how long cert is valid
    ##################################
    EXP_DATE=$(openssl x509 -in "$CERT_FILE" -noout -enddate | cut -d= -f2)
    if [ -z "$EXP_DATE" ]; then
      echo "Error: Failed to parse expiry date for $domain."
      continue
    fi

    EXP=$(date -d "$EXP_DATE" +%s 2>/dev/null)
    DATE_NOW=$(date -d "now" +%s)
    DAYS_EXP=$(echo \( $EXP - $DATE_NOW \) / 86400 |bc)

    if [ "$DAYS_EXP" -gt "$EXP_LIMIT" ]; then
      echo "$domain, no need for renewal ($DAYS_EXP days left)."

      # Even if not due for renewal, ensure HAProxy combined cert is up-to-date
      live_full="/etc/letsencrypt/live/${domain}/fullchain.pem"
      live_priv="/etc/letsencrypt/live/${domain}/privkey.pem"
      combined="/etc/haproxy/certs/${domain}.pem"

      # If combined missing, create it from live if available
      if [ ! -f "$combined" ]; then
        if [ -f "$live_full" ] && [ -f "$live_priv" ]; then
          echo "Combined file missing for $domain, creating from live certs..."
          combine_certs "$domain"
        else
          echo "Combined file missing and live certs not present for $domain, skipping."
        fi
      else
        # If live exists, compare mtimes; update if live is newer
        if [ -f "$live_full" ] && [ -f "$live_priv" ]; then
          live_full_mtime=$(stat -c '%Y' "$live_full" 2>/dev/null || echo 0)
          live_priv_mtime=$(stat -c '%Y' "$live_priv" 2>/dev/null || echo 0)
          combined_mtime=$(stat -c '%Y' "$combined" 2>/dev/null || echo 0)
          if [ "$live_full_mtime" -gt "$combined_mtime" ] || [ "$live_priv_mtime" -gt "$combined_mtime" ]; then
            echo "Live certs for $domain are newer than combined file, updating combined..."
            combine_certs "$domain"
          else
            echo "Combined cert for $domain is up-to-date."
          fi
        else
          echo "Live cert files missing for $domain, nothing to update."
        fi
      fi
    else
      #################################
      # Renew Certificate
      #################################
      echo "The certificate for $domain is about to expire soon ($DAYS_EXP days left)."
      echo "Starting Let's Encrypt renewal script... If you need to check logs, please refer to /var/log/letsencrypt/letsencrypt.log"
      certbot certonly \
        --webroot --webroot-path $WEB_ROOT \
        --force-renewal \
        --text \
        -v \
        --email $EMAIL \
        --agree-tos \
        -d $domain

      ###################################
      #
      # Combine certs for HAProxy and
      # Reload HAProxy
      #
      ###################################
      combine_certs $domain

    fi
  fi
done

# uncomment bind * 443, make certs work
sed -i 's/^#\( *bind *\*:443 ssl crt-list \/etc\/haproxy\/cert-list.cfg\)/\1/' /usr/local/etc/haproxy/haproxy.cfg

if [ "$RELOAD" = true ]
then
  echo " ========================= "
  echo " =                       = "
  echo " === Reloading HAProxy === "
  echo " =                       = "
  echo " ========================= "
#   haproxy -f /usr/local/etc/haproxy/haproxy.cfg -sf $(cat /var/run/haproxy.pid)
  supervisorctl restart haproxy
fi
